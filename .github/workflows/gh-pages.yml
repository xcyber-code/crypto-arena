name: Publish to GitHub Pages

on:
  workflow_run:
    workflows: ["CI", "Benchmarks"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  publish:
    name: üì§ Publish Reports to GitHub Pages
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create publish directory
        run: mkdir -p publish

      - name: Download Allure Results
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: allure-results
          path: downloaded/allure-results
          if_no_artifact_found: warn
          search_artifacts: true
          check_artifacts: true
        continue-on-error: true

      - name: Download JMH Results (from Benchmarks)
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: benchmarks.yml
          workflow_conclusion: success
          name: jmh-results
          path: downloaded/jmh-results
          if_no_artifact_found: warn
          search_artifacts: true
        continue-on-error: true

      - name: Download JCStress Results (from Benchmarks)
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: benchmarks.yml
          workflow_conclusion: success
          name: jcstress-results
          path: downloaded/jcstress-results
          if_no_artifact_found: warn
          search_artifacts: true
        continue-on-error: true

      - name: Install Allure CLI
        run: |
          mkdir -p /tmp/allure-cli
          curl -o /tmp/allure.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.tgz
          tar -zxvf /tmp/allure.tgz -C /tmp/allure-cli
          echo "/tmp/allure-cli/allure-2.29.0/bin" >> $GITHUB_PATH

      - name: Debug downloaded artifacts
        run: |
          echo "=== Downloaded directory structure ==="
          ls -la downloaded/ 2>/dev/null || echo "No downloaded directory"
          echo ""
          echo "=== Allure results ==="
          if [ -d "downloaded/allure-results" ]; then
            echo "Directory exists"
            find downloaded/allure-results -type f 2>/dev/null | head -20 || echo "No files"
            echo "File count: $(find downloaded/allure-results -type f 2>/dev/null | wc -l)"
          else
            echo "No allure results directory"
          fi
          echo ""
          echo "=== JMH results ==="
          find downloaded/jmh-results -type f 2>/dev/null | head -20 || echo "No JMH results"
          echo ""
          echo "=== JCStress results ==="
          find downloaded/jcstress-results -type f 2>/dev/null | head -20 || echo "No JCStress results"

      - name: Generate Allure Report
        run: |
          mkdir -p publish/allure
          
          echo "=== Allure results structure ==="
          find downloaded/allure-results -type f 2>/dev/null | head -30 || echo "No files found"
          
          if [ -d "downloaded/allure-results" ] && [ -n "$(find downloaded/allure-results -name '*.json' 2>/dev/null)" ]; then
            allure generate downloaded/allure-results --clean -o publish/allure
            echo "‚úÖ Allure report generated"
          else
            echo "<html><body><h1>No Allure Results</h1><p>No test results available yet. Make sure tests are running and generating Allure results.</p></body></html>" > publish/allure/index.html
            echo "‚ö†Ô∏è No Allure results found"
          fi

      - name: Generate JMH HTML Report
        run: |
          mkdir -p publish/benchmarks/jmh
          if [ -d "downloaded/jmh-results" ] && [ -n "$(ls -A downloaded/jmh-results 2>/dev/null)" ]; then
            # Copy raw results
            cp -r downloaded/jmh-results/* publish/benchmarks/jmh/
            # Generate HTML report from JSON inline
            python3 - downloaded/jmh-results publish/benchmarks/jmh << 'PYTHON_EOF'
          import json, html, os, sys
          from pathlib import Path

          input_dir, output_dir = sys.argv[1], sys.argv[2]
          Path(output_dir).mkdir(parents=True, exist_ok=True)

          json_file = None
          for root, _, files in os.walk(input_dir):
              for f in files:
                  if f.endswith(".json"):
                      json_file = os.path.join(root, f)
                      break
              if json_file:
                  break

          if not json_file:
              Path(output_dir, "index.html").write_text("<html><body><h1>No JMH Results</h1></body></html>")
              sys.exit(0)

          with open(json_file, "r") as f:
              data = json.load(f)

          benchmarks = data if isinstance(data, list) else data.get("benchmarks", [])
          rows = []
          for b in benchmarks:
              name = html.escape(b.get("benchmark", ""))
              mode = html.escape(b.get("mode", ""))
              pm = b.get("primaryMetric", {})
              score = pm.get("score", 0)
              unit = html.escape(pm.get("scoreUnit", ""))
              error = pm.get("scoreError", 0)
              params = b.get("params", {})
              params_str = ", ".join(f"{k}={v}" for k, v in params.items()) if params else "-"
              rows.append((name, params_str, mode, f"{score:.2f}", unit, f"¬± {error:.2f}" if error else "-"))

          table_rows = "".join(f'<tr><td>{n}</td><td>{p}</td><td><span class="mode">{m}</span></td><td class="score">{s}</td><td>{u}</td><td class="error">{e}</td></tr>' for n, p, m, s, u, e in rows)

          html_out = f'''<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>JMH Benchmark Results - Crypto Arena</title>
            <style>
              * {{ box-sizing: border-box; margin: 0; padding: 0; }}
              body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #fff; padding: 40px 20px; }}
              .container {{ max-width: 1200px; margin: 0 auto; }}
              h1 {{ font-size: 2rem; margin-bottom: 8px; }}
              .subtitle {{ color: #8892b0; margin-bottom: 30px; }}
              .back-link {{ color: #007bff; text-decoration: none; display: inline-block; margin-bottom: 20px; }}
              .back-link:hover {{ text-decoration: underline; }}
              table {{ width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; }}
              th, td {{ padding: 14px 16px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }}
              th {{ background: rgba(255,255,255,0.1); font-weight: 600; color: #ccd6f6; }}
              tr:hover {{ background: rgba(255,255,255,0.03); }}
              .score {{ font-weight: bold; color: #64ffda; }}
              .error {{ color: #8892b0; font-size: 0.9em; }}
              .mode {{ background: rgba(100,255,218,0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }}
              footer {{ margin-top: 40px; text-align: center; color: #8892b0; font-size: 0.85rem; }}
            </style>
          </head>
          <body>
            <div class="container">
              <a href="../" class="back-link">‚Üê Back to Reports</a>
              <h1>‚ö° JMH Benchmark Results</h1>
              <p class="subtitle">Java Microbenchmark Harness performance measurements</p>
              <table>
                <thead>
                  <tr><th>Benchmark</th><th>Parameters</th><th>Mode</th><th>Score</th><th>Unit</th><th>Error</th></tr>
                </thead>
                <tbody>{table_rows}</tbody>
              </table>
              <footer><p>Generated from JMH results ‚Ä¢ {len(rows)} benchmark(s) executed</p></footer>
            </div>
          </body>
          </html>'''

          Path(output_dir, "index.html").write_text(html_out)
          print(f"Generated JMH HTML report with {len(rows)} benchmarks")
          PYTHON_EOF
          else
            echo "<html><body><h1>No JMH Results</h1><p>No benchmark results available yet.</p></body></html>" > publish/benchmarks/jmh/index.html
            echo "‚ö†Ô∏è No JMH results found"
          fi

      - name: Copy JCStress Results
        run: |
          mkdir -p publish/benchmarks/jcstress
          if [ -d "downloaded/jcstress-results" ] && [ -n "$(ls -A downloaded/jcstress-results 2>/dev/null)" ]; then
            cp -r downloaded/jcstress-results/* publish/benchmarks/jcstress/
            echo "‚úÖ JCStress results copied"
          else
            echo "<html><body><h1>No JCStress Results</h1><p>No stress test results available yet.</p></body></html>" > publish/benchmarks/jcstress/index.html
            echo "‚ö†Ô∏è No JCStress results found"
          fi

      - name: Generate Global Index
        run: |
          cat > publish/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Crypto Arena - Reports</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #fff; }
              .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
              h1 { font-size: 2.5rem; margin-bottom: 10px; }
              .subtitle { color: #8892b0; margin-bottom: 40px; }
              .reports { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
              .report-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 24px; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s, box-shadow 0.2s; }
              .report-card:hover { transform: translateY(-4px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
              .report-card .icon { font-size: 2rem; margin-bottom: 12px; }
              .report-card h3 { font-size: 1.25rem; margin-bottom: 8px; }
              .report-card p { color: #8892b0; font-size: 0.9rem; margin-bottom: 16px; line-height: 1.5; }
              .report-card a { display: inline-block; background: #007bff; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: background 0.2s; }
              .report-card a:hover { background: #0056b3; }
              footer { margin-top: 60px; text-align: center; color: #8892b0; font-size: 0.85rem; }
              footer a { color: #007bff; text-decoration: none; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üöÄ Crypto Arena</h1>
              <p class="subtitle">High-performance cryptocurrency trading platform reports</p>
              <div class="reports">
                <div class="report-card">
                  <div class="icon">üìä</div>
                  <h3>Allure Test Report</h3>
                  <p>Detailed test results with steps, attachments, and execution history</p>
                  <a href="./allure/">View Report</a>
                </div>
                <div class="report-card">
                  <div class="icon">‚ö°</div>
                  <h3>JMH Benchmarks</h3>
                  <p>Java Microbenchmark Harness performance results and metrics</p>
                  <a href="./benchmarks/jmh/">View Benchmarks</a>
                </div>
                <div class="report-card">
                  <div class="icon">üî•</div>
                  <h3>JCStress Tests</h3>
                  <p>Concurrency stress test results for thread-safety validation</p>
                  <a href="./benchmarks/jcstress/">View Results</a>
                </div>
              </div>
              <footer>
                <p>Generated by GitHub Actions ‚Ä¢ <a href="https://github.com/riad-cyber-coder/crypto-arena">View Repository</a></p>
              </footer>
            </div>
          </body>
          </html>
          EOF

      - name: Debug final structure
        run: |
          echo "=== Final structure ==="
          find publish -type f | head -50

      - name: Deploy to gh-pages using action
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./publish
          user_name: github-actions[bot]
          user_email: github@users.noreply.github.com
          keep_files: false
          allow_empty_commit: true
